var mqtt=require("mqtt"),i=require("debug")("Gateway:inflow"),o=require("debug")("Gateway:outflow"),g=require("debug")("Gateway:normal"),m=require("debug")("Gateway:mqtt"),e=require("debug")("Gateway:errors"),util=require("util"),EventEmitter=require("events"),uniqid=require("uuid/v1"),REMOTE_ADDR=null;function node(opt){var _node=this;EventEmitter.call(_node),_node.key=opt.key,_node.rx_uid="default",_node.auth=!1,_node.uid=uniqid(),_node.created_at=Date.now(),_node.con_name=opt.con_name||"default",_node.type=opt.type||"fullflow",_node.REMOTE=null,_node.init=function(){_node.REMOTE=mqtt.connect(REMOTE_ADDR,{keepalive:5,will:{topic:_node.uid+"/dkcs/dead/node",payload:JSON.stringify({type:2,data:{created_at:Date.now(),config_id:_node.key,uid:_node.uid,rx_uid:_node.rx_uid},channel:"",to:null})}}),_node.REMOTE.on("connect",function(){var check={type:0,data:{uid:_node.uid,config_id:_node.key,lwt:!0},channel:"",to:null},raw_data=JSON.stringify(check);_node.REMOTE.subscribe(_node.uid+"/pingzee/dkcs/auth/response",function(){_node.REMOTE.publish("pingzee/dkcs/auth/fullflow",raw_data)})}),_node.REMOTE.on("reconnect",function(){_node.emit("error","Network is unavilable , trying to reconnect"),_node.auth=!1}),_node.REMOTE.on("message",function(topic,message,pkt){switch(topic){case _node.uid+"/pingzee/dkcs/auth/response":0===(main_Data=JSON.parse(message.toString())).type&&(_node.con_name=main_Data.data.con_name,_node.rx_uid=main_Data.data.rx_uid,_node.REMOTE.subscribe(main_Data.data.rx_uid+"/"+_node.uid+"/pingzee/data/rx")),_node.emit("data",main_Data);break;case _node.rx_uid+"/"+_node.uid+"/pingzee/data/rx":var main_Data=JSON.parse(message.toString());_node.emit("data",main_Data)}})},_node.send=function(message,channel,recipient){var check={type:1,data:{message:message,uid:_node.uid},channel:channel,to:recipient||null,from:_node.con_name};_node.REMOTE.publish(_node.rx_uid+"/"+_node.uid+"/pingzee/data/tx",JSON.stringify(check))}}REMOTE_ADDR="ws://mqtt.pingzee.xyz:8083/mqtt",util.inherits(node,EventEmitter);var connect=function(opt){if("object"==typeof opt||void 0===opt){var err={status:!1,comment:"TypeError:parameter type is "+typeof opt+" , Json Object required"};return e(err),err}var newConnection={};newConnection.key=opt,newConnection.type="fullflow";var newNode=new node(newConnection);return newNode.init(),newNode};module.exports={connect:connect};
